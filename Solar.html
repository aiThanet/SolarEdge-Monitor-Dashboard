<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <script>
      const SITES = [
        {
          name: "SolarEdge METER1",
          meter: "METER1",
          chart: null,
        },
        {
          name: "SolarEdge METER2",
          meter: "METER2",
          chart: null,
        },
      ];
      const API_URL = "http://mathongapi.jpn.local";
      // const API_URL = "http://localhost:3100";
      const consumption_txt = "ปริมาณใช้ไฟฟ้า";
      const production_txt = "พลังงานแสงอาทิตย์ผลิต";

      setInterval(() => {
        updatePowerFlow();
      }, 5 * 1000);

      setInterval(() => {
        updateChart();
      }, 15 * 60 * 1000);

      setInterval(() => {
        updateBenefit();
      }, 30 * 60 * 1000);

      const updatePowerFlow = () => {
        SITES.forEach((site) => {
          const meter = site.meter;
          //call api
          $.ajax({
            url: `${API_URL}/solar/current?site=${meter}`,
            type: "GET",
            contentType: "application/json",
            success: function (data) {
              const siteCurrentPowerFlow = data.siteCurrentPowerFlow;
              //update html
              $(`div#${meter} #PV_VAL`).html(
                siteCurrentPowerFlow.PV.currentPower + " kW"
              );
              $(`div#${meter} #LOAD_VAL`).html(
                siteCurrentPowerFlow.LOAD.currentPower + " kW"
              );
              $(`div#${meter} #GRID_VAL`).html(
                siteCurrentPowerFlow.GRID.currentPower + " kW"
              );
              siteCurrentPowerFlow.connections.forEach((con) => {
                const from = con.from.toLowerCase();
                const to = con.to.toLowerCase();

                if (from === "pv" && to === "load") {
                  $(`div#${meter} #PV_LOAD`).attr("src", "./Right.svg");
                } else if (from === "load" && to === "pv") {
                  $(`div#${meter} #PV_LOAD`).attr("src", "./Left.svg");
                } else if (from === "load" && to === "grid") {
                  $(`div#${meter} #LOAD_GRID`).attr("src", "./Right.svg");
                } else if (from === "grid" && to === "load") {
                  $(`div#${meter} #LOAD_GRID`).attr("src", "./Left.svg");
                }
              });
            },
          });
        });
      };

      const updateBenefit = () => {
        SITES.forEach((site) => {
          const meter = site.meter;
          //call api
          $.ajax({
            url: `${API_URL}/solar/benefit?site=${meter}`,
            type: "GET",
            contentType: "application/json",
            success: function (data) {
              const envBenefits = data.envBenefits;
              //update html
              $(`div#${meter} #SE_CO2`).html(
                envBenefits.gasEmissionSaved.co2.toFixed(2) +
                  " " +
                  envBenefits.gasEmissionSaved.units
              );
              $(`div#${meter} #SE_TREE`).html(
                envBenefits.treesPlanted.toFixed(2) + " ต้น"
              );
            },
          });
        });
      };

      const updateChart = () => {
        SITES.forEach((site) => {
          const meter = site.meter;

          const start_time = moment()
            .startOf("day")
            .format("YYYY-MM-DD HH:mm:ss");

          const end_time = moment().endOf("day").format("YYYY-MM-DD HH:mm:ss");
          //call api
          $.ajax({
            url: `${API_URL}/solar/powerDetails?site=${meter}&start_time=${start_time}&end_time=${end_time}`,
            type: "GET",
            contentType: "application/json",
            success: function (data) {
              const powerDetails = data.powerDetails;
              const unit = powerDetails.unit.toUpperCase();
              const meters = powerDetails.meters;
              let dates = [];
              let consumption = [];
              let production = [];

              meters.forEach((meter) => {
                if (meter.type == "Consumption") {
                  dates = meter.values.map((data) =>
                    data.date.substring(11, 16)
                  );
                  consumption = meter.values.map((data) => data.value || 0);
                }
                if (meter.type == "Production") {
                  production = meter.values.map((data) => data.value || 0);
                }
              });

              site.chart = Highcharts.chart(`${meter}-chart`, {
                chart: {
                  type: "area",
                },
                title: {
                  text: `Power and Energy ${meter}`,
                },
                tooltip: {
                  shared: true,
                  pointFormat: "{series.name}: <b>{point.y}</b><br/>",
                  valueSuffix: " kW",
                  useHTML: true,
                  formatter: function () {
                    return this.points.reduce(function (s, point) {
                      return (
                        s +
                        "<div style='width: 250px' class='d-flex justify-content-between'> <div><span class='" +
                        (point.series.name == production_txt
                          ? "text-success"
                          : "text-danger") +
                        "'>■ </span>" +
                        point.series.name +
                        "</div><div class='fw-bold'>" +
                        (point.y / 1000).toFixed(2) +
                        " kW</div></div>"
                      );
                    }, "<div class='mb-3 fw-bold'> Power Overview - " +
                      this.x +
                      "</div>");
                  },
                },
                xAxis: {
                  allowDecimals: false,
                  categories: dates,
                  gridLineWidth: 1,
                  tickInterval: 8,
                },
                yAxis: {
                  title: {
                    text: unit,
                    align: "high",
                    rotation: 0,
                    x: 30,
                    y: -20,
                  },
                },
                plotOptions: {
                  area: {
                    marker: {
                      enabled: false,
                      symbol: "circle",
                      radius: 2,
                      states: {
                        hover: {
                          enabled: true,
                        },
                      },
                    },
                  },
                },
                series: [
                  {
                    name: consumption_txt,
                    data: consumption,
                    color: "rgba(237,51,51,0.7)",
                  },
                  {
                    name: production_txt,
                    data: production,
                    color: "rgba(0,176,80,0.7)",
                  },
                ],
              });
            },
          });
        });
      };
      updatePowerFlow();
      updateBenefit();
      updateChart();
    </script>
    <h2 class="fw-bold py-2 mb-0 bg-success text-center">
      ปริมาณการใช้และการผลิตไฟฟ้า ประจำวันที่ <span id="today"></span>
    </h2>
    <div class="container-fluid text-center mx-3">
      <div class="row">
        <div class="col-12" id="METER1">
          <div class="container-fluid text-center">
            <div class="row">
              <h2 class="mt-3 mb-1">METER1: โรงทอ ชั้น1/2 (เริ่ม 01/04/67)</h2>
            </div>
            <div class="row">
              <div class="col-8 mx-3">
                <div class="row" style="position: relative">
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="PV_VAL">0 kW</h2>
                    <img
                      src="./PV.svg"
                      class="img-fluid"
                      alt="PV"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                  <img
                    src="./Right.svg"
                    class="px-0"
                    alt="Right"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 33.33%;
                      width: 56px;
                      height: 56px;
                      transform: translate(-50%, -50%);
                    "
                    id="PV_LOAD"
                  />
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="LOAD_VAL">0 kW</h2>
                    <img
                      src="./Load.svg"
                      class="img-fluid"
                      alt="Load"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                  <img
                    src="./Right.svg"
                    class="px-0"
                    alt="Right"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 66.66%;
                      width: 56px;
                      height: 56px;
                      transform: translate(-50%, -50%);
                    "
                    id="LOAD_GRID"
                  />
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="GRID_VAL">0 kW</h2>
                    <img
                      src="./Grid.svg"
                      class="img-fluid"
                      alt="Grid"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                </div>
              </div>
              <div class="col-3 mx-3">
                <div class="row text-start">
                  <div class="col-12 bg-success border border-dark-subtle">
                    <h3 class="mt-2 px-2 text-white text-center">
                      ช่วยรักษาสิ่งแวดล้อม
                    </h3>
                  </div>
                  <div class="col-12 border border-dark-subtle d-flex">
                    <div>
                      <img
                        src="./se-co2-icon.png"
                        class="img-fluid"
                        alt="se-co2"
                        style="width: 90px; height: 90px"
                      />
                    </div>
                    <div class="d-flex flex-column align-self-center ms-2">
                      <h5>ลดการปล่อย CO2</h5>
                      <h4 class="fw-bold text-success" id="SE_CO2">0 kg</h4>
                    </div>
                  </div>
                  <div class="col-12 border border-dark-subtle d-flex">
                    <div>
                      <img
                        src="./se-tree-icon.png"
                        class="img-fluid"
                        alt="se-tree"
                        style="width: 90px; height: 90px"
                      />
                    </div>
                    <div class="d-flex flex-column align-self-center ms-2">
                      <h5>เทียบเท่ากับปลูกต้นไม้</h5>
                      <h4 class="fw-bold text-success" id="SE_TREE">0 ต้น</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12" id="METER2">
          <div class="container-fluid text-center">
            <div class="row">
              <h2 class="mt-3 mb-1">
                METER2: ออฟฟิต ตัวบ้าน ปั๊มลม (เริ่ม 01/04/67)
              </h2>
            </div>
            <div class="row">
              <div class="col-8 mx-3">
                <div class="row" style="position: relative">
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="PV_VAL">0 kW</h2>
                    <img
                      src="./PV.svg"
                      class="img-fluid"
                      alt="PV"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                  <img
                    src="./Right.svg"
                    class="px-0"
                    alt="Right"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 33.33%;
                      width: 56px;
                      height: 56px;
                      transform: translate(-50%, -50%);
                    "
                    id="PV_LOAD"
                  />
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="LOAD_VAL">0 kW</h2>
                    <img
                      src="./Load.svg"
                      class="img-fluid"
                      alt="Load"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                  <img
                    src="./Right.svg"
                    class="px-0"
                    alt="Right"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 66.66%;
                      width: 56px;
                      height: 56px;
                      transform: translate(-50%, -50%);
                    "
                    id="LOAD_GRID"
                  />
                  <div
                    class="col-4 border border-dark-subtle"
                    style="height: 240px"
                  >
                    <h2 class="mt-2" id="GRID_VAL">0 kW</h2>
                    <img
                      src="./Grid.svg"
                      class="img-fluid"
                      alt="Grid"
                      style="width: 75%; max-width: 150px"
                    />
                  </div>
                </div>
              </div>
              <div class="col-3 mx-3">
                <div class="row text-start">
                  <div class="col-12 bg-success border border-dark-subtle">
                    <h3 class="mt-2 px-2 text-white text-center">
                      ช่วยรักษาสิ่งแวดล้อม
                    </h3>
                  </div>
                  <div class="col-12 border border-dark-subtle d-flex">
                    <div>
                      <img
                        src="./se-co2-icon.png"
                        class="img-fluid"
                        alt="se-co2"
                        style="width: 90px; height: 90px"
                      />
                    </div>
                    <div class="d-flex flex-column align-self-center ms-2">
                      <h5>ลดการปล่อย CO2</h5>
                      <h4 class="fw-bold text-success" id="SE_CO2">0 kg</h4>
                    </div>
                  </div>
                  <div class="col-12 border border-dark-subtle d-flex">
                    <div>
                      <img
                        src="./se-tree-icon.png"
                        class="img-fluid"
                        alt="se-tree"
                        style="width: 90px; height: 90px"
                      />
                    </div>
                    <div class="d-flex flex-column align-self-center ms-2">
                      <h5>เทียบเท่ากับปลูกต้นไม้</h5>
                      <h4 class="fw-bold text-success" id="SE_TREE">0 ต้น</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-6">
          <div id="METER1-chart" style="width: 100%; height: 350px"></div>
        </div>
        <div class="col-6">
          <div id="METER2-chart" style="width: 100%; height: 350px"></div>
        </div>
      </div>
    </div>

    <script>
      $(`span#today`).html(moment().format("DD/MM/YYYY"));
    </script>
  </body>
</html>
